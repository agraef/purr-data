<!DOCTYPE html>
<html>
  <head>
    <link id="page_style" rel="stylesheet"
          type="text/css" href="css/default.css">
  </head>
  <body class="dialog_body" style="overflow: hidden;">
    <div class="container">
      <table id="titlebar">
        <tr>
          <td style="width: 100%;">
            <div id="titlebar_title">Iemgui Properties</div>
          </td>
          <td id="titlebar_buttons_td">
            <div class="titlebar_buttons">
              <div id="titlebar_close_button" onclick="cancel(false);">&#215</div>
            </div>
          </td>
        </tr>
      </table>
    <form> 
      <fieldset> 
        <legend data-i18n="iem.prop.heading.size"></legend> 

        <table class="pairs">
          <tr class="size prop hidden">
            <td>
              <label data-i18n="[title]iem.prop.size_tt">
                <span data-i18n="iem.prop.size"></span>
              </label>
            </td>
            <td data-i18n="[title]iem.prop.size_tt">
              <input type="text" name="size"
                     onchange="update_attr(this);">
            </td>
          </tr>
          <tr class="selection_size prop hidden">
            <td>
              <label data-i18n="[title]iem.prop.select_size_tt">
                <span data-i18n="iem.prop.select_size"></span>
              </label>
            </td>
            <td data-i18n="[title]iem.prop.select_size_tt">
              <input type="text" name="selection_size"
                     onchange="update_attr(this);">
            </td>
          </tr>
          <tr class="number prop hidden">
            <td>
              <label data-i18n="[title]iem.prop.number_tt">
                <span data-i18n="iem.prop.number"></span>
              </label>
            </td>
            <td data-i18n="[title]iem.prop.number_tt">
              <input type="number" name="number"
                     onchange="update_attr(this);">
            </td>
          </tr>
          <tr class="nonzero_value prop hidden">
            <td>
              <label data-i18n="[title]iem.prop.nonzero_value_tt">
                <span data-i18n="iem.prop.nonzero_value"></span>
              </label>
            </td>
            <td data-i18n="[title]iem.prop.nonzero_value_tt">
              <input type="text" name="nonzero_value"
                     onchange="update_attr(this);">
            </td>
          </tr>
          <tr class="width prop hidden">
            <td>
              <label data-i18n="[title]iem.prop.width_tt" class="mknob_size_tt"> 
                <span data-i18n="iem.prop.width" class="mknob_size"></span>
              </label>
            </td>
            <td data-i18n="[title]iem.prop.width_tt" class="mknob_size_tt">
              <input type="text" name="width"
                     onchange="update_attr(this);">
            </td>
            <td>
              <label data-i18n="[title]iem.prop.height_tt" class="mknob_steps_tt">
                <span data-i18n="iem.prop.height" class="mknob_steps"></span>
              </label>
            </td>
            <td data-i18n="[title]iem.prop.height_tt" class="mknob_steps_tt">
              <input type="text" name="height"
                     onchange="update_attr(this);">
            </td>
          </tr>
          <tr class="visible_width prop hidden">
            <td>
              <label data-i18n="[title]iem.prop.visible_width_tt">
                <span data-i18n="iem.prop.visible_width"></span>
              </label>
            </td>
            <td data-i18n="[title]iem.prop.visible_width_tt">
              <input type="text" name="visible_width"
                     onchange="update_attr(this);">
            </td>
            <td>
              <label data-i18n="[title]iem.prop.visible_height_tt">
                <span data-i18n="iem.prop.visible_height"></span>
              </label>
            </td>
            <td data-i18n="[title]iem.prop.visible_height_tt">
              <input type="text" name="visible_height"
                     onchange="update_attr(this);">
            </td>
          </tr>
          <tr class="minimum_range prop pair hidden">
            <td>
              <label data-i18n="[title]iem.prop.minimum_tt">
                <span data-i18n="iem.prop.minimum"></span>
              </label>
            </td>
            <td data-i18n="[title]iem.prop.minimum_tt">
              <input type="text" name="minimum_range"
                     onchange="update_attr(this);">
            </td>
            <td>
              <label data-i18n="[title]iem.prop.maximum_tt">
                <span data-i18n="iem.prop.maximum"></span>
              </label>
            </td>
            <td data-i18n="[title]iem.prop.max_mum_tt">
              <input type="text" name="maximum_range"
                     onchange="update_attr(this);">
            </td>
          </tr>
          <tr class="flash_interrupt prop hidden">
            <td>
              <label data-i18n="[title]iem.prop.flash_interrupt_tt">
                <span data-i18n="iem.prop.flash_interrupt"></span>
              </label>
            </td>
            <td data-i18n="[title]iem.prop.flash_interrupt_tt">
              <input type="text" name="flash_interrupt"
                     onchange="update_attr(this);">
            </td>
            <td>
              <label data-i18n="[title]iem.prop.flash_hold_tt">
                <span data-i18n="iem.prop.flash_hold"></span>
              </label>
            </td>
            <td data-i18n="[title]iem.prop.flash_hold_tt">
              <input type="text" name="flash_hold"
                     onchange="update_attr(this);">
            </td>
          </tr>
          <tr class="log_height prop hidden">
            <td></td><td></td>
            <td>
              <label data-i18n="[title]iem.prop.log_height_tt">
                <span data-i18n="iem.prop.log_height"></span>
              </label>
            </td>
            <td>
              <input type="text" name="log_height"
                     onchange="update_attr(this);">
            </td>
          </tr>
        </table>

        <div class="init prop hidden">
          <label data-i18n="[title]iem.prop.init_tt">
            <input type="checkbox" name="init" value="on"
                   onchange="update_attr(this);">
            <span data-i18n="iem.prop.init"></span>
          </label>
          <br>
        </div>

        <div class="vu_scale prop hidden">
          <label data-i18n="[title]iem.prop.vu_scale_tt">
            <span data-i18n="iem.prop.vu_scale"></span>
            <input type="checkbox" name="vu_scale" value="on"
                   onchange="update_attr(this);">
          </label>
          <br>
        </div>

        <div class="log_scaling prop hidden">
          <label data-i18n="[title]iem.prop.log_scale_tt">
            <input type="checkbox" name="log_scaling" value="on"
                   onchange="update_attr(this);">
            <span data-i18n="iem.prop.log_scale"></span>
          </label>
          <br>
        </div>

        <div class="steady_on_click prop hidden">
          <label data-i18n="[title]iem.prop.steady_tt">
            <input type="checkbox" name="steady_on_click" value="on"
                   onchange="update_attr(this);">
            <span data-i18n="iem.prop.steady"></span>
          </label>
          <br>
        </div>
      </fieldset> 

      <fieldset> 
        <legend data-i18n="iem.prop.heading.messages"></legend> 

        <table>
          <tr class="send_symbol prop hidden">
            <td>
              <label data-i18n="[title]iem.prop.send_tt">
                <span data-i18n="iem.prop.send"></span>
              </label>
            </td>
            <td data-i18n="[title]iem.prop.send_tt">
              <input type="text" name="send_symbol"
                     onchange="update_attr(this, true);"
                     style="width: 12em;">
            </td>
            <td>
          <tr class="receive_symbol prop hidden">
            <td>
              <label data-i18n="[title]iem.prop.receive_tt">
                <span data-i18n="iem.prop.receive"></span>
              </label>
            </td>
            <td data-i18n="[title]iem.prop.receive_tt">
              <input type="text" name="receive_symbol"
                     onchange="update_attr(this, true);"
                     style="width: 12em;">
            </td>
            <td>
          </tr>
        </table>
      </fieldset> 

      <fieldset> 
        <legend data-i18n="iem.prop.heading.label">wrong stuff</legend> 

        <table class="pairs">
          <tr class="label prop hidden">
            <td>
              <label data-i18n="[title]iem.prop.label_tt">
                <span data-i18n="iem.prop.label"></span>
              </label>
            </td>
            <td data-i18n="[title]iem.prop.label_tt">
              <input type="text" name="label"
                     onchange="update_attr(this, true);"
                     style="width: 131px;">
            </td>
            <td>
              <label data-i18n="[title]iem.prop.xoffset_tt">
                <span data-i18n="iem.prop.xoffset"></span>
              </label>
            </td>
            <td data-i18n="[title]iem.prop.xoffset_tt">
              <input type="text" name="x_offset"
                     onchange="update_attr(this);">
            </td>
            <td>
              <label data-i18n="[title]iem.prop.yoffset_tt">
                <span data-i18n="iem.prop.yoffset"></span>
              </label>
            </td>
            <td data-i18n="[title]iem.prop.yoffset_tt">
              <input type="text" name="y_offset"
                     onchange="update_attr(this);">
            </td>
          </tr>
          <tr class="font_style prop hidden">
            <td>
              <label data-i18n="[title]iem.prop.font_tt">
                <span data-i18n="iem.prop.font"></span>
            </td>
            <td data-i18n="[title]iem.prop.font_tt">
              <select name="font_style"
                      onchange="update_attr(this);">
                <option>DejaVu Sans Mono</option>
                <option>Helvetica</option>
                <option>Times</option>
              </select>
            </td>
            <td colspan="4">
              <label data-i18n="[title]iem.prop.fontsize_tt">
                <span data-i18n="iem.prop.fontsize"></span>
                <input type="text" name="font_size"
                       onchange="update_attr(this);">
              <label>
            </td>
          </tr>
        </table>
      </fieldset> 

      <fieldset> 
      <legend data-i18n="iem.prop.heading.colors"></legend> 

      <table class="draw_style prop hidden" style="margin-bottom: 7px;">
        <tr>
          <td>
            <label data-i18n="[title]iem.prop.drawstyle_tt">
              <span data-i18n="iem.prop.drawstyle"
                style="margin-right: 6px;"></span>
            </label>
          </td>
          <td data-i18n="[title]iem.prop.drawstyle_tt">
            <select name="draw_style"
                   onchange="update_attr(this, true);"
                   style="width: 14em;">
              <option value="0">draw everything (default)</option>
              <option value="1">draw frame only</option>
              <option value="2">draw triangle only</option>
              <option value="3">draw number only</option> 
            </select>
          </td>
          <td>
      </table>

      <div class="background_color prop hidden">
        <label data-i18n="[title]iem.prop.bgcolor_tt">
          <input type="color" name="background_color"
                 onchange="update_attr(this);">
          <span data-i18n="iem.prop.bgcolor"></span>
        </label>
        <br>
      </div>

      <div class="foreground_color prop hidden">
        <label data-i18n="[title]iem.prop.fgcolor_tt">
          <input type="color" name="foreground_color"
                 onchange="update_attr(this);">
          <span data-i18n="iem.prop.fgcolor"></span>
        </label>
        <br>
      </div>

      <div class="label_color prop hidden">
        <label data-i18n="[title]iem.prop.label_color_tt">
          <input type="color" name="label_color"
                 onchange="update_attr(this);">
          <span data-i18n="iem.prop.label_color"></span>
        </label>
        <br>
      </div>
    </fieldset> 

    <div class="prop hidden">
      <input type="hidden" name="minimum_size">
      <input type="hidden" name="range_schedule">
      <input type="hidden" name="hide_frame">
    </div>

    <div class="submit_buttons">
      <button type="button" onClick="ok()" data-i18n="[title]iem.prop.ok_tt">
        <span data-i18n="iem.prop.ok"></span>
      </button>
      <button type="button" onClick="apply()" data-i18n="[title]iem.prop.apply_tt">
        <span data-i18n="iem.prop.apply"></span>
      </button>
      <button type="button" onClick="cancel(true)" data-i18n="[title]iem.prop.cancel_tt">
        <span data-i18n="iem.prop.cancel"></span>
      </button>
    </div>

  </form> 
  </div>      

  <script>
"use strict";
var gui = require("nw.gui");
var pdgui = require("./pdgui.js");

// For translations
var l = pdgui.get_local_string;

// gui preset
pdgui.skin.apply(window);

var pd_object_callback,
    old_attrs = {}, // original state. Used if we cancel the dialog
    new_attrs = {}; // changed state. Used if we apply or click "Ok"

function substitute_space(arg) {
    var fake_space = String.fromCharCode(11);
    return arg.split(" ").join(fake_space);
}

function strip_problem_chars(arg) {
    var problem_chars = [";", ",", "\\"],
        ret = arg,
        i;
    for(i = 0; i < problem_chars.length; i++) {
        ret = ret.split(problem_chars[i]).join("");
    }
    return ret;
}

function update_attr(elem, symbol_field) {
    if (!new_attrs.hasOwnProperty(elem.name)) {
        pdgui.post("warning: new_attrs[" + elem.name + "] doesn't exist");
    }
    if (elem.type === "checkbox") {
        new_attrs[elem.name] = elem.checked ? 1 : 0;
    } else if (elem.type === "select-one") {
        new_attrs[elem.name] = elem.selectedIndex;
    } else if (elem.type === "color") {
        new_attrs[elem.name] = parseInt(elem.value.slice(1), 16)
    } else {
        new_attrs[elem.name] = (elem.value === "" && !symbol_field) ?
            "0" : elem.value;
    }
}

//Clean up strings to send as symbol arguments to Pd
function iemgui_escape(s) {
    s = !s ? "empty" : s;
    var arr = s.split("");
    for (var i = 0; i < arr.length; i++) {
        if (arr[i] === "$" && i+1 < arr.length &&
            arr[i+1] >= "0" && arr[i+1] <= "9") {
            arr[i] = "#";
        }
    }
    s = arr.join("");
    s = substitute_space(s);
    s = strip_problem_chars(s);
    return s;
}

function iemgui_unescape(s) {
    var arr = s.split("");
    for (var i = 0; i < arr.length; i++) {
        if (arr[i] === "#" && i+1 < arr.length &&
            arr[i+1] >= "0" && arr[i+1] <= "9") {
            arr[i] = "$";
        }
    }
    s = arr.join("");
    return s;
}

function send_params(attrs, create_undo_point) {
    /* Not sure what these are...
        iemgui_clip_dim $id
        iemgui_clip_num $id
        iemgui_sched_rng $id
        iemgui_verify_rng $id
        iemgui_sched_rng $id
        iemgui_clip_fontsize $id
    */

    var send_symbol = attrs.send_symbol,
        receive_symbol = attrs.receive_symbol,
        label =  attrs["label"];
    send_symbol = iemgui_escape(send_symbol);
    receive_symbol = iemgui_escape(receive_symbol);
    label = iemgui_escape(label);

    var label_x_offset =  attrs.x_offset;
    var label_y_offset =  attrs.y_offset;

    // make sure the offset boxes have a value
    if (!label_x_offset) {
        label_x_offset = 0;
    }
    if (!label_y_offset) {
        label_y_offset = 0;
    }

    var height, width;
    var size = attrs["size"];
    if (size === undefined) {
        size = attrs.selection_size;
    }

    if (size !== undefined) {
        width = size;
        height = size;
    } else {
        width = attrs.width;
        height = attrs.height;
    }

    var slot3 = attrs.minimum_range;
    var slot4 = attrs.maximum_range;

    if (slot3 === undefined) {
        slot3 = attrs.flash_interrupt;
        slot4 = attrs.flash_hold;
    }

    if (slot3 === undefined) {
        slot3 = attrs.visible_width;
        slot4 = attrs.visible_height;
    }

    if (slot3 === undefined) { // toggle
        slot3 = attrs.nonzero_value;
        if (slot3 === undefined) {
            slot3 = 0;
        }
        slot4 = 0;
    }

    var slot5 = attrs.log_scaling ? +attrs.log_scaling : 0;
    // Hack to accomodate the vu_scale property, which exists in the same
    // slot as this one
    var log_scaling_div = document.querySelector(".log_scaling");
    var no_log_display = log_scaling_div.classList.contains("hidden");

    if (no_log_display) {
        slot5 = attrs.vu_scale ? +attrs.vu_scale : 0;
    }

    var init = +attrs["init"];
    if (!init) { init = 0; }

    var slot7 = attrs.log_height;
    if (slot7 === undefined) {
        slot7 = attrs["number"];
    }
    if (slot7 === undefined) {
        slot7 = 0;
    }

    var font_style = attrs.font_style;
    //if (font_style !== null) { font_style = 0; }

    var font_size = attrs.font_size;
    if (font_size === undefined) { font_size = 0; }

    // [vu] doesn't have a foreground color
    var foreground_color = attrs.foreground_color ?
        attrs.foreground_color : 0;
    var background_color = attrs.background_color;
    var label_color = attrs.label_color;

    var slot18 = attrs.steady_on_click ? +attrs.steady_on_click : 0;

    var draw_style = attrs.draw_style ? +attrs.draw_style : 0;

    pdgui.pdsend(pd_object_callback, "dialog",
        width, height,
        slot3, // bng: flash_interrupt
               // slider: min_range
               // toggle: nonzero_value
               // my_canvas: visible_width
        slot4, // bng: flash_hold
               // slider: max_range
               // my_canvas: visible_height
        slot5, // slider: lin/log thingy
               // nbx: lin/log
               // vu: vu_scale
        init,
        slot7, // log_height or vradio/hradio number
        send_symbol, receive_symbol, label,
        label_x_offset, label_y_offset,
        font_style, font_size,
        background_color, foreground_color,
        label_color,
        slot18, // steady on click
        draw_style, // numbox draw style
        create_undo_point ? 1 : 0 // whether we set an undo point
    );
}

function cancel(revert_changes) {
    var dirty = false, attr;
    //window.close(true);
    if (revert_changes) {
        for (attr in old_attrs) {
            if (old_attrs[attr] !== new_attrs[attr]) {
                dirty = true;
            }
        }
        if (dirty) {
            send_params(old_attrs, false);
        }
    }
    pdgui.pdsend(pd_object_callback, "cancel");
}

function apply() {
    send_params(new_attrs, false);
}

function ok() {
    // Steal focus from any active input to make sure it triggers an
    // onchange event
    document.querySelector("button").focus();
    // send the old attrs first so we can set an undo point on them
    send_params(old_attrs, false);
    send_params(new_attrs, true);
    cancel(false);
}

function change_width_and_height_labels() {
    [".mknob_steps", ".mknob_size"].forEach(function(sel) {
        Array.prototype.forEach.call(
            document.body.querySelectorAll(sel), function(e) {
            e.setAttribute("data-i18n", "iem.prop" + sel);
        });
	Array.prototype.forEach.call(
            document.body.querySelectorAll(sel + "_tt"), function(e) {
                e.setAttribute("data-i18n", "[title]iem.prop" + sel + "_tt");
        });
    });
}

// This gets called from the nw_create_window function in index.html
// It provides us with our window id from the C side.  Once we have it
// we can create the menu and register event callbacks
function register_window_id(gfxstub, attr_object) {
    var attr;
    pd_object_callback = gfxstub;
    old_attrs = attr_object;
    for (attr in old_attrs) {
        if (old_attrs.hasOwnProperty(attr)) {
            new_attrs[attr] = old_attrs[attr];
        }
    }
    //console.log("attr object is " + attr_object.toString() +
    //    " and its type is " + attr_object.type);
    add_events(gfxstub);
    pdgui.gui_check_for_dialog_appearance_inconsistencies(gfxstub);

    // Special case for [moonlib/mknob] which leverages the iemgui dialog--
    // change the label for "height" to "steps"
    if (attr_object.type === "mknob") {
        change_width_and_height_labels();
    }

    // ico@vt.edu TODO: translate the window title
    // for the timebeing we just give it english version
    document.getElementById("titlebar_title").textContent = "[" + 
        attr_object.type + "] Iemgui Properties";

    translate_form();
    populate_form(attr_object);
    // We don't turn on rendering of the "container" div until
    // We've finished displaying all the spans and populating the
    // labels and form elements.  That makes it more efficient and
    // snappier, at least on older machines.
    document.getElementsByClassName("container")[0]
        .style.setProperty("display", "inline");
    pdgui.resize_window(pd_object_callback);
}

// Stop-gap translator
function translate_form() {
    var i
    var elements = document.querySelectorAll("[data-i18n]");
    for (i = 0; i < elements.length; i++) {
        var data = elements[i].dataset.i18n;
        if (data.slice(0,7) === "[title]") {
            elements[i].title = l(data.slice(7));
        } else {
            elements[i].textContent = l(data);
        }
    }
}

function populate_form(attr_object) {
    var attr;
    for(attr in attr_object) {
        // Unhide the span with the class with the same name as the id
        var prop_group = document.getElementsByClassName(attr)[0];
        if (prop_group !== undefined) {
            //console.log("the thing here is " + attr);
            prop_group.classList.remove("hidden");
        }
        // iemguis use the string 'empty' for null because of
        // the limitations of Pd's state-saving API.  So we have
        // to filter that one out
        if (attr_object[attr] !== "empty") {
            var elem = document.getElementsByName(attr);
            if (elem.length > 0) {
                if (attr.slice(-5) === "color") {
                    var hex_string = Number(attr_object[attr]).toString(16);
                    var color_string = "#" +
                        (hex_string === "0" ? "000000" : hex_string);
                    //pdgui.post("color is " + color_string);
                    elem[0].value = color_string;
                } else if (elem[0].type === "checkbox") {
                    // The attr here is a string, so we need to
                    // force it to number, hence the "+" below
                    elem[0].checked = +attr_object[attr];
                } else if (elem[0].type === "select-one") {
                    elem[0].selectedIndex = +attr_object[attr];
                } else if (attr === "send_symbol" ||
                           attr === "receive_symbol" ||
                           attr === "label") {
                    elem[0].value = iemgui_unescape(attr_object[attr]);
                } else {
                    elem[0].value = attr_object[attr];
                }
            }
        }
    }
}

function add_events(name) {
    // closing the Window
    gui.Window.get().on("close", function() {
        // this needs to do whatever the "cancel" button does
        cancel(false);
    });
    pdgui.dialog_bindings(name);
}

  </script>
  </body>
</html>
